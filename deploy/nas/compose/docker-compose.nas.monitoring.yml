services:
  grafana:
    image: grafana/grafana:11.3.0
    container_name: scanium-grafana
    restart: unless-stopped
    env_file:
      - ../env/monitoring.env
    ports:
      - "3000:3000"
    volumes:
      - /volume1/docker/scanium/monitoring/grafana:/var/lib/grafana
      - ${REPO_ROOT}/monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ${REPO_ROOT}/monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - loki
      - tempo
      - mimir
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/api/health | grep -q '\"database\"'"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - scanium_net

  loki:
    image: grafana/loki:3.2.1
    container_name: scanium-loki
    restart: unless-stopped
    command: ["-config.file=/etc/loki/loki.yaml"]
    volumes:
      - /volume1/docker/scanium/monitoring/loki:/loki
      - ${REPO_ROOT}/monitoring/loki/loki.yaml:/etc/loki/loki.yaml:ro
    networks:
      - scanium_net

  tempo:
    image: grafana/tempo:2.6.1
    container_name: scanium-tempo
    restart: unless-stopped
    command: ["-config.file=/etc/tempo/tempo.yaml"]
    volumes:
      - /volume1/docker/scanium/monitoring/tempo:/var/tempo
      - ${REPO_ROOT}/monitoring/tempo/tempo.yaml:/etc/tempo/tempo.yaml:ro
    networks:
      - scanium_net

  mimir:
    image: grafana/mimir:2.17.4
    container_name: scanium-mimir
    restart: unless-stopped
    command: ["-config.file=/etc/mimir/mimir.yaml"]
    volumes:
      - /volume1/docker/scanium/monitoring/mimir:/data
      - ${REPO_ROOT}/monitoring/mimir/mimir.yaml:/etc/mimir/mimir.yaml:ro
    networks:
      - scanium_net

  alloy:
    image: grafana/alloy:v1.5.0
    container_name: scanium-alloy
    restart: unless-stopped
    command:
      - run
      - --server.http.listen-addr=0.0.0.0:12345
      - /etc/alloy/config.alloy
    ports:
      - "127.0.0.1:12345:12345"  ***REMOVED*** Admin UI - localhost only for security
      - "4317:4317"               ***REMOVED*** OTLP gRPC - needs external access for telemetry
      - "4318:4318"               ***REMOVED*** OTLP HTTP - needs external access for telemetry
    volumes:
      - ${REPO_ROOT}/monitoring/alloy/config.alloy:/etc/alloy/config.alloy:ro
      ***REMOVED*** Optional: persist Alloy WAL so restarts don't drop buffered remote_write
      ***REMOVED*** - /volume1/docker/scanium/monitoring/alloy:/var/lib/alloy
    depends_on:
      - loki
      - tempo
      - mimir
    networks:
      - scanium_net


networks:
  scanium_net:
    name: compose_scanium_net
    driver: bridge
    attachable: true
