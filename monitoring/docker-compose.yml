# Scanium Observability Stack (LGTM + Alloy)
# - Loki: Logs storage
# - Grafana: Visualization
# - Tempo: Distributed tracing
# - Mimir: Metrics storage
# - Alloy: OTLP receiver & routing

services:
  # Grafana Alloy - OTLP receiver and telemetry router
  alloy:
    image: grafana/alloy:v1.0.0
    container_name: scanium-alloy
    restart: unless-stopped
    ports:
      - "4317:4317"           # OTLP gRPC (public - app telemetry ingestion)
      - "4318:4318"           # OTLP HTTP (public - app telemetry ingestion)
      - "127.0.0.1:12345:12345" # Alloy UI/metrics (localhost only - debugging)
    volumes:
      - ./alloy/alloy.hcl:/etc/alloy/config.alloy:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./data/alloy:/var/lib/alloy/data
    command:
      - run
      - /etc/alloy/config.alloy
      - --server.http.listen-addr=0.0.0.0:12345
      - --storage.path=/var/lib/alloy/data
    networks:
      - observability
      - backend_scanium-network
    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/localhost/12345'"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 15s

  # Loki - Log aggregation
  loki:
    image: grafana/loki:2.9.3
    container_name: scanium-loki
    restart: unless-stopped
    ports:
      - "127.0.0.1:3100:3100"  # HTTP/metrics (localhost only - debugging)
    volumes:
      - ./loki/loki.yaml:/etc/loki/config.yaml:ro
      - ./data/loki:/loki
    command: -config.file=/etc/loki/config.yaml
    networks:
      - observability
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3100/ready"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  # Tempo - Distributed tracing
  tempo:
    image: grafana/tempo:2.7.0
    container_name: scanium-tempo
    restart: unless-stopped
    user: "0:0"  # Run as root to fix permission denied errors during compaction (GH-409)
    ports:
      - "127.0.0.1:3200:3200"  # HTTP/metrics (localhost only - debugging)
      - "4317"                 # OTLP gRPC (internal only - no host binding)
    volumes:
      - ./tempo/tempo.yaml:/etc/tempo/config.yaml:ro
      - ./tempo/overrides.yaml:/etc/tempo/overrides.yaml:ro
      - ./data/tempo:/var/tempo
    command: -config.file=/etc/tempo/config.yaml
    networks:
      - observability
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3200/ready"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  # Mimir - Metrics storage (Prometheus-compatible)
  mimir:
    image: grafana/mimir:2.11.0
    container_name: scanium-mimir
    restart: unless-stopped
    ports:
      - "127.0.0.1:9009:9009"  # HTTP/metrics (localhost only - debugging)
    volumes:
      - ./mimir/mimir.yaml:/etc/mimir/config.yaml:ro
      - ./data/mimir:/data
    command:
      - -config.file=/etc/mimir/config.yaml
      - -target=all
      # Querier config: ensure recent data from ingesters is queryable
      - -querier.query-ingesters-within=12h
      - -querier.query-store-after=0s
    networks:
      - observability
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9009/ready"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  # Grafana - Visualization and dashboards
  grafana:
    build:
      context: ./grafana
      dockerfile: Dockerfile
    image: scanium-grafana:latest
    container_name: scanium-grafana
    restart: unless-stopped
    ports:
      - "3000:3000"  # Grafana UI (publicly exposed)
    environment:
      # Anonymous auth for easy local dev (change for production)
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_DISABLE_LOGIN_FORM=true

      # Paths
      - GF_PATHS_PROVISIONING=/etc/grafana/provisioning
      - GF_PATHS_DATA=/var/lib/grafana

      # Server
      - GF_SERVER_ROOT_URL=https://grafana.gtemp1.com
      - GF_SERVER_SERVE_FROM_SUB_PATH=false

      # Disable usage stats
      - GF_ANALYTICS_REPORTING_ENABLED=false
      - GF_ANALYTICS_CHECK_FOR_UPDATES=false

      # Feature toggles
      - GF_FEATURE_TOGGLES_ENABLE=traceqlEditor
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
      - ./data/grafana:/var/lib/grafana
    networks:
      - observability
      - backend_scanium-network  # Connect to backend network for cloudflared access
    depends_on:
      loki:
        condition: service_healthy
      tempo:
        condition: service_healthy
      mimir:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

networks:
  observability:
    name: scanium-observability
    driver: bridge
  backend_scanium-network:
    external: true

volumes:
  # Named volumes for easier backup/restore
  loki_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/loki

  tempo_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/tempo

  mimir_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/mimir

  grafana_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/grafana
