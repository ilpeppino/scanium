name: golden-classification-tests

on:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * *"
  pull_request:
    types: [opened, synchronize, labeled]

jobs:
  golden-tests:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'run-golden-tests'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Detect dataset
        run: |
          if [ -d "external/golden-tests/scanium-golden-tests/tests/golden_images/by_subtype" ]; then
            echo "SCANIUM_GOLDEN_TESTS_PATH=external/golden-tests/scanium-golden-tests/tests/golden_images/by_subtype" >> "$GITHUB_ENV"
          elif [ -d "external/golden-tests/scanium-golden-tests/golden_images/by_subtype" ]; then
            echo "SCANIUM_GOLDEN_TESTS_PATH=external/golden-tests/scanium-golden-tests/golden_images/by_subtype" >> "$GITHUB_ENV"
          else
            echo "SKIP_GOLDEN_TESTS=1" >> "$GITHUB_ENV"
          fi

      - name: Run golden tests
        if: env.SKIP_GOLDEN_TESTS != '1'
        run: ./gradlew :androidApp:testDevDebugUnitTest --tests com.scanium.app.golden.GoldenDatasetRegressionTest
        env:
          SCANIUM_BASE_URL: ${{ secrets.SCANIUM_BASE_URL }}
          SCANIUM_API_KEY: ${{ secrets.SCANIUM_API_KEY }}
