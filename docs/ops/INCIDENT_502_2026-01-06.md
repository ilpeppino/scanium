# Incident Report: HTTP 502 Bad Gateway

**Date:** 2026-01-06
**Duration:** ~12 hours (from container restart at ~07:02 UTC until fix at ~19:05 UTC)
**Severity:** Critical (all API traffic affected)

## Symptoms

- All public API endpoints returning HTTP 502 (Bad Gateway)
- `/health`, `/v1/config`, `/v1/preflight`, `/v1/assist/*` all affected
- 502 responses came from Cloudflare (indicated by `server: cloudflare` header)
- `/v1/assist/status` specifically returned 403 (Cloudflare WAF block - separate issue)
- Backend container reported healthy (`docker ps` showed "Up 12 hours (healthy)")

## Root Cause

**Docker network mismatch between cloudflared and backend containers.**

The `scanium-cloudflared` container could not resolve the `scanium-backend` hostname because they were on different Docker networks:

| Container | Networks |
|-----------|----------|
| `scanium-backend` | `scanium_net` |
| `scanium-cloudflared` | `backend_scanium-network`, `compose_scanium_net` |

The Cloudflare tunnel ingress configuration pointed to `http://scanium-backend:8080`, which requires Docker DNS resolution. Since the containers didn't share a network, DNS lookup failed:

```
ERR error="Unable to reach the origin service. The service may be down or
it may not be responding to traffic from cloudflared: dial tcp: lookup
scanium-backend on 127.0.0.11:53: no such host"
```

This likely occurred because the backend container was started from a different compose project (`scanium_net`) than the cloudflared container expected.

## Timeline

- **07:02 UTC** - Cloudflared container restarted, began failing to reach backend
- **07:46 UTC** - First error logs recorded for `/v1/config` requests
- **14:34 UTC** - Multiple health check failures from Android app
- **19:03 UTC** - Investigation started
- **19:05 UTC** - Fix applied, connectivity restored

## Resolution

### Immediate Fix
Connected cloudflared to the backend's network:
```bash
docker network connect scanium_net scanium-cloudflared
```

### Permanent Fix
Updated `/volume1/docker/cloudflared/docker-compose.yml` to include `scanium_net`:

```yaml
networks:
  - backend_scanium-network
  - compose_scanium_net
  - scanium_net  # Added to resolve scanium-backend hostname

networks:
  backend_scanium-network:
    external: true
  compose_scanium_net:
    external: true
  scanium_net:
    external: true  # Added
```

## Prevention

1. **Smoke test script added:** `scripts/ops/smoke.sh` tests public endpoints
   - `/health` - should return 200
   - `/v1/config` - should return 401 (auth required)
   - `/v1/assist/status` - should return 401 or 403

2. **Automated monitoring deployed:** Docker-based smoke monitor runs every 5 minutes
   ```bash
   # Deploy on NAS:
   cd /volume1/docker/scanium/repo/deploy/nas/compose
   docker compose -f docker-compose.nas.monitor.yml up -d

   # View logs:
   tail -f /volume1/docker/scanium/logs/smoke.log
   ```

3. **Network documentation:**
   - All containers requiring inter-service communication must share a Docker network
   - The `scanium_net` network is the canonical network for backend services

## Lessons Learned

- Container health checks don't detect network connectivity issues between containers
- Cloudflare tunnel logs are essential for diagnosing 502s - always check for DNS/connection errors
- Multiple compose projects can lead to network fragmentation if not carefully coordinated
