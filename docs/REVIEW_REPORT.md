***REMOVED*** Scanium Architecture & Code Review

***REMOVED******REMOVED*** A) Executive Summary
- Camera-first flow and shared-tracking abstractions remain consistent with documented intent, but continuous-scanning currently bypasses streaming/track-aware detection due to crash avoidance, reducing dedup stability and risking UX regressions. 【F:docs/ARCHITECTURE.md†L7-L17】【F:androidApp/src/main/java/com/scanium/app/camera/CameraXManager.kt†L335-L349】
- Item aggregation and enhanced classification run on the main thread with heavy logging and memory introspection, which can jank the UI under burst detections; background offloading and log gating are needed. 【F:androidApp/src/main/java/com/scanium/app/items/ItemsViewModel.kt†L111-L144】【F:androidApp/src/main/java/com/scanium/app/items/ItemsViewModel.kt†L245-L295】
- Cloud classification code logs HTTP bodies and can persist cropped images in debug builds; this risks leaking user content and should be hardened before enabling cloud paths. 【F:androidApp/src/main/java/com/scanium/app/ml/classification/CloudClassifier.kt†L89-L176】
- Classification orchestration still depends on Android bitmap adapters, blocking KMP portability of the “shared brain”; adapters/interfaces are needed to keep shared modules Android-free. 【F:androidApp/src/main/java/com/scanium/app/ml/classification/ClassificationOrchestrator.kt†L3-L67】
- CI parity is limited in the container: `./gradlew test` and `./gradlew lint` fail without an Android SDK; use workstation/CI runners for validation. 【dd6fab†L1-L12】【1ec8cd†L14-L25】

***REMOVED******REMOVED*** B) Architecture & Modularity Review
- **Alignment with docs:** Modules and layering match the documented separation (androidApp UI + platform adapters + shared tracking/models). 【F:docs/ARCHITECTURE.md†L7-L17】 Camera entry, ML wrappers, and tracking hooks exist as described. However, continuous scanning currently forces `SINGLE_IMAGE_MODE` and skips tracker-based streaming, diverging from the intended “CameraX → tracking → aggregation” pipeline. 【F:androidApp/src/main/java/com/scanium/app/camera/CameraXManager.kt†L335-L349】【F:androidApp/src/main/java/com/scanium/app/camera/CameraXManager.kt†L476-L539】
- **Boundary drift:** Classification orchestration imports Android bitmap adapters (`toBitmap`) and runs inside the ViewModel scope, blending platform concerns into logic that should be portable for iOS/KMP. 【F:androidApp/src/main/java/com/scanium/app/ml/classification/ClassificationOrchestrator.kt†L3-L75】 CloudClassifier directly references `BuildConfig` and Android `Context`, so it cannot be reused on iOS without an abstraction. 【F:androidApp/src/main/java/com/scanium/app/ml/classification/CloudClassifier.kt†L67-L103】
- **Future-proofing gaps:** No explicit interface separates platform image conversion from classification orchestration; double ML invocation during tracking (`detectObjectsWithTracking` + `detectObjects`) increases latency and complicates moving tracker logic into shared modules. 【F:androidApp/src/main/java/com/scanium/app/camera/CameraXManager.kt†L485-L538】 Add contracts in `shared/core-tracking` or `shared/core-models` for analyzer inputs/outputs and inject platform adapters.

***REMOVED******REMOVED*** C) Code Quality & Reliability Review
- **Main-thread heavy aggregation:** `addItems` performs per-frame aggregation, heap logging, and stats computation synchronously; invoked from the UI thread this risks dropped frames. 【F:androidApp/src/main/java/com/scanium/app/items/ItemsViewModel.kt†L111-L144】 Move aggregation/classification dispatch to a background dispatcher and gate verbose logging behind debug flags.
- **Tracker bypass in scanning:** Continuous scanning sets `useStreamMode=false` to avoid ML Kit crashes, so tracking metadata is unused and dedup depends solely on bounding boxes, increasing duplicates and unstable item IDs. 【F:androidApp/src/main/java/com/scanium/app/camera/CameraXManager.kt†L335-L349】 Reintroduce streaming with safer backpressure (e.g., throttled analyzer) or document the limitation explicitly.
- **Double detection per frame:** When tracking is enabled, each frame runs both `detectObjectsWithTracking` and a full `detectObjects` call, doubling ML workload and latency. 【F:androidApp/src/main/java/com/scanium/app/camera/CameraXManager.kt†L485-L538】 Consider enriching a single detection pass to supply both tracker metadata and overlay data.
- **Classification state mutation:** `triggerEnhancedClassification` mutates shared `AggregatedItem` state and UI flows directly inside callbacks; without synchronization this could surface races if background scopes change. 【F:androidApp/src/main/java/com/scanium/app/items/ItemsViewModel.kt†L245-L295】 Encapsulate aggregator updates behind thread-safe methods or dispatch updates on the main dispatcher explicitly.

***REMOVED******REMOVED*** D) UI/UX Review
- **Permission denial handling:** Camera permission loss clears detections but shows no educative UI; users may see an inert camera screen. Consider a dedicated “camera access required” state with actions. 【F:androidApp/src/main/java/com/scanium/app/camera/CameraScreen.kt†L148-L162】
- **Scan feedback & accessibility:** Core controls have content descriptions, but the header logo is decorative with `contentDescription=null` and no TalkBack hint for scanning gestures (tap vs long-press). Add semantics and helper text near the shutter to improve discoverability. 【F:androidApp/src/main/java/com/scanium/app/camera/CameraScreen.kt†L540-L685】
- **Mode-switch ergonomics:** Mode switcher is always visible yet its state is not persisted across configuration changes beyond `rememberSaveable` defaults; consider surfacing current mode in overlay text for clarity. 【F:androidApp/src/main/java/com/scanium/app/camera/CameraScreen.kt†L99-L123】【F:androidApp/src/main/java/com/scanium/app/camera/CameraScreen.kt†L585-L600】

***REMOVED******REMOVED*** E) Performance Review
- **Analyzer overhead:** For each analyzed frame, the pipeline converts `ImageProxy` to `Bitmap` for thumbnails even when not needed, allocating large buffers and increasing GC pressure. 【F:androidApp/src/main/java/com/scanium/app/camera/CameraXManager.kt†L404-L428】 Add lazy thumbnail generation only when classification requires it.
- **Aggregation on UI thread:** Heap inspection and repeated `getStats()` calls per batch add CPU overhead during rapid detections. 【F:androidApp/src/main/java/com/scanium/app/items/ItemsViewModel.kt†L111-L144】 Move stats/telemetry off the hot path and collect asynchronously.
- **Measurement plan:** Instrument analyzer latency, frame rate, and classification turnaround inside `CameraXManager.startScanning` and `ClassificationOrchestrator.classifyWithRetry`; capture metrics via simple `Long` timestamps and logcat tags, then graduate to trace markers. Profile on mid-tier device with `./gradlew installDebug` + `adb shell am profile start/stop` per DEV_GUIDE commands. 【F:docs/DEV_GUIDE.md†L40-L55】

***REMOVED******REMOVED*** F) Security & Privacy Review
- **Logging of sensitive content:** CloudClassifier logs response bodies and can save JPEG crops when debug flags are enabled, which may capture user belongings; sanitize logs and keep debug cropping opt-in via developer settings. 【F:androidApp/src/main/java/com/scanium/app/ml/classification/CloudClassifier.kt†L89-L176】
- **Config surface clarity:** Cloud classifier is disabled when `SCANIUM_API_BASE_URL` is blank, but expected configuration steps are only in DEV_GUIDE; mirror the requirement in-app (e.g., status banner) to avoid accidental network use once keys are provided. 【F:docs/DEV_GUIDE.md†L8-L39】【F:androidApp/src/main/java/com/scanium/app/ml/classification/CloudClassifier.kt†L89-L140】
- **Dependency scanning:** OWASP Dependency-Check exists in CI; ensure it remains enabled when Gradle/AGP changes land. 【F:docs/CI_CD.md†L3-L12】【F:docs/SECURITY.md†L3-L15】

***REMOVED******REMOVED*** G) CI/CD & Developer Experience
- **Container limitations:** Unit tests and lint fail locally without an Android SDK; rely on CI/workstation for full validation. 【dd6fab†L1-L12】【1ec8cd†L14-L25】 Consider a lightweight JVM-only task (shared modules) as a pre-push guard.
- **KMP warnings:** Kotlin multiplatform emits compatibility warnings with AGP 8.5.0 in shared modules; track upstream compatibility or pin AGP/Kotlin versions to tested pairs in CI. 【bd0b52†L1-L36】
- **Coverage expectations:** DEV_GUIDE lists kover thresholds; ensure CI adds coverage workflows per plan. 【F:docs/DEV_GUIDE.md†L40-L47】【F:docs/CI_CD.md†L3-L12】

***REMOVED******REMOVED*** H) Actionable Backlog (Prioritized)

| ID | Title | Category | Severity | Effort | Risk | Owner type | Evidence | Recommendation |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| P0-1 | Restore tracker-friendly streaming path | Functional/Performance | High | M | Med | Android | 【F:androidApp/src/main/java/com/scanium/app/camera/CameraXManager.kt†L335-L349】【F:androidApp/src/main/java/com/scanium/app/camera/CameraXManager.kt†L476-L539】 | Re-enable `STREAM_MODE` with backpressure guards (throttled analyzer, frame-skipping) and add regression tests to ensure stable IDs and dedup work without crashes. |
| P0-2 | Harden cloud logging & debug crops | Security/Privacy | High | S | Med | Android | 【F:androidApp/src/main/java/com/scanium/app/ml/classification/CloudClassifier.kt†L89-L176】 | Remove response-body logging in production, gate crop saving behind developer toggle, and document retention paths; add redaction for request/response metadata. |
| P1-1 | Offload aggregation/classification from UI thread | Performance/DX | Medium | M | Med | Shared/Android | 【F:androidApp/src/main/java/com/scanium/app/items/ItemsViewModel.kt†L111-L144】【F:androidApp/src/main/java/com/scanium/app/items/ItemsViewModel.kt†L245-L295】 | Move aggregator/classifier dispatch to a background dispatcher, buffer results, and expose immutable state to UI; wrap verbose logs in debug checks. |
| P1-2 | Reduce duplicate ML passes during tracking | Performance | Medium | M | Low | Android | 【F:androidApp/src/main/java/com/scanium/app/camera/CameraXManager.kt†L485-L538】 | Consolidate detection to a single ML Kit call that returns both tracker metadata and overlay info, or cache results between calls. |
| P1-3 | Abstract classifier inputs for KMP | Modularity | Medium | M | Med | Shared | 【F:androidApp/src/main/java/com/scanium/app/ml/classification/ClassificationOrchestrator.kt†L3-L67】 | Introduce platform-neutral `ImageRef` classification contract in shared modules; adapt Android bitmaps via `android-platform-adapters` before invoking orchestrator. |
| P2-1 | Improve permission-denied UX | UX | Low | S | Low | Android | 【F:androidApp/src/main/java/com/scanium/app/camera/CameraScreen.kt†L148-L162】 | Show a dedicated empty/blocked state with rationale and a button to open system settings when camera permission is denied. |
| P2-2 | Optimize thumbnail allocation | Performance | Medium | S | Low | Android | 【F:androidApp/src/main/java/com/scanium/app/camera/CameraXManager.kt†L404-L428】 | Generate thumbnails lazily only for promoted/stable items; reuse buffers or downscale aggressively to reduce allocations. |
| P3-1 | Add in-app cloud config status | Functional/UX | Low | S | Low | Android | 【F:docs/DEV_GUIDE.md†L8-L39】【F:androidApp/src/main/java/com/scanium/app/ml/classification/CloudClassifier.kt†L89-L140】 | Surface whether cloud classification is active/disabled in settings, and guide users to configure base URL/API key safely. |
| P3-2 | CI coverage + JVM guardrails | DX/CI | Low | M | Low | DevEx | 【F:docs/CI_CD.md†L3-L12】【dd6fab†L1-L12】【1ec8cd†L14-L25】 | Add a JVM-only check (shared modules tests) for container runs and extend CI to enforce kover thresholds and AGP/Kotlin compatibility. |

